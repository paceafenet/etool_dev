---
title: "eTool Dev Code"
author: "Travis Sondgerath"
date: "`r Sys.Date()`"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      warning = F,
                      message = F)

library(dplyr)
library(shiny)
library(shinyWidgets)
library(sparkline)  # Make sure I need this package
library(DT)
library(tibble)
library(lubridate)
library(rmarkdown)
library(leaflet)
library(tidyr)

curr_date <- mdy("1/1/2017")

googlesheets::gs_auth(token = "shiny_app_token.rds")
my_sheets <- googlesheets::gs_ls()

sheet_key <- my_sheets$sheet_key[1]
ss <- googlesheets::gs_key(my_sheets$sheet_key[1])

ss_data <- googlesheets::gs_read_csv(ss) %>% 
  mutate(manufacture_date = mdy(manufacture_date),
         date_active = mdy(date_active),
         date_not_viable = mdy(date_not_viable),
         most_recent_calibration = mdy(most_recent_calibration),
         next_calibration = mdy(next_calibration),
         most_recent_maintenance = mdy(most_recent_maintenance),
         next_maintenance = mdy(next_maintenance),
         retirement_date = mdy(retirement_date),
         requires_attn = if_else(condition = date_not_viable < curr_date |
                                   next_calibration < curr_date |
                                   next_maintenance < curr_date,
                                 true = "red",
                                 false = if_else(condition = date_not_viable - curr_date < 10 |
                                                   next_calibration - curr_date < 10 |
                                                   next_maintenance - curr_date < 10,
                                                 true = "yellow",
                                                 false = "blue")))
```

{.sidebar}

```{r}

# materialSwitch(inputId = "attn_toggle",
#                label = "Toggle to Facilities with Equip Requiring Attention:",
#                status = "info")

pickerInput(inputId = "attn_level",
            label = "Choose Facilities with Equip Requiring Attention:",
            choices = unique(ss_data$requires_attn),
            selected = unique(ss_data$requires_attn),
            multiple = T)

```

Row {data-height=650}
-----------------------------------------------------------------------

### Leaflet

```{r}

renderLeaflet({

# attn_flag <- ""
# attn_flag[input$attn_toggle == TRUE] <- c("red", "yellow")
# attn_flag[input$attn_toggle == FALSE] <- c("red", "yellow", "blue")

tt <- ss_data %>% 
  filter(requires_attn %in% c(input$attn_level)) %>% 
  # filter(requires_attn %in% c(attn_flag)) %>% 
  group_by(facility, lat, long, requires_attn) %>% 
  tally() %>% 
  spread(key = requires_attn, value = n) %>% 
  ungroup() %>% 
  mutate(requires_attn = if_else(condition = red > 0,
                                 true = "red",
                                 false = if_else(yellow > 0,
                                                 true = "yellow",
                                                 false = "blue")),
         lat = jitter(lat, factor = 1),
         long = jitter(long, factor = 1)) %>% 
  leaflet() %>% 
  addTiles() %>%
  addCircleMarkers(lng = ~long, 
                   lat = ~lat, 
                   popup = ~facility,
                   color = ~requires_attn,
                   fill = F)

tt

})
```

Row {.tabset .tabset-fade data-height=350}
-----------------------------------------------------------------------

### Chart B

```{r}

```

Row {data-height=350}
-----------------------------------------------------------------------

### Chart C

```{r}

```
